<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>UNSW Escape-Room Editor</title>
<style>
/* ─── 颜色变量 ─────────────────────────────────────────── */
:root{
  --unsw-yellow:#ffe600;
  --unsw-charcoal:#231f20;
  --sidebar-w:220px;
  --toolbar-w:280px;
}

/* ─── reset ───────────────────────────────────────────── */
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
html,body{height:100%;background:#fff;color:var(--unsw-charcoal)}
.hidden{display:none}

/* ─── 顶栏 ─────────────────────────────────────────────── */
.topbar{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:var(--unsw-yellow);display:flex;align-items:center;
  gap:1.3rem;padding:0 1rem;font-weight:700;z-index:1000}
.topbar a{margin-left:auto;font-weight:600;text-decoration:none;color:inherit}
.topbar a+ a{margin-left:1rem}

/* ─── 主体 3 列布局 ───────────────────────────────────── */
body{padding-top:56px}
.layout{display:flex;height:calc(100% - 56px)}

/* ─── 侧栏缩略图 ─────────────────────────────────────── */
.sidebar{
  width:var(--sidebar-w);overflow-y:auto;padding:10px 4px 14px;background:#fff}
.thumb{
  height:100px;margin-bottom:10px;cursor:pointer;border:2px solid transparent;border-radius:4px}
.thumb:hover,.thumb.active{border-color:var(--unsw-yellow)}
.thumb-preview{
  width:100%;height:100%;background:#f6f6f6;border-radius:2px;
  overflow:hidden;display:flex;align-items:flex-start;justify-content:flex-start}
.thumb-preview>*{transform:scale(.20);transform-origin:top left}

/* ─── 中央白板 ───────────────────────────────────────── */
.whiteboard-wrapper{flex:1;display:flex;flex-direction:column;align-items:center;overflow:auto;padding:20px}
.whiteboard{
  flex:1;width:100%;max-width:900px;min-height:300px;border:3px dashed var(--unsw-yellow);
  border-radius:6px;padding:2rem;overflow:auto;background:var(--wb-bg,#fff);color:var(--wb-color,#000)}
.controls{margin-top:12px;display:flex;gap:1rem}

/* ─── 右侧工具条 ─────────────────────────────────────── */
.toolbar{
  width:var(--toolbar-w);padding:1.25rem;border-left:4px solid var(--unsw-yellow);overflow-y:auto}
.toolbar h2{font-size:1.1rem;margin-bottom:1rem;font-weight:700}
label{display:block;font-size:.85rem;margin-top:1rem}
input[type="color"],input[type="number"],textarea,select{
  width:100%;padding:.45rem;border:1px solid #ccc;border-radius:4px;margin-top:.35rem}

/* ─── 通用按钮 ──────────────────────────────────────── */
button{cursor:pointer;padding:.5rem 1.1rem;border:0;border-radius:4px;background:var(--unsw-yellow);
       color:var(--unsw-charcoal);font-weight:700}
button:hover{background:#e6cf00}

/* ─── 反馈弹层 ──────────────────────────────────────── */
.feedback{
  position:fixed;top:60%;left:50%;transform:translate(-50%,-50%);
  padding:1.4rem 2rem;background:var(--unsw-yellow);color:var(--unsw-charcoal);
  border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.25);z-index:2000;width:280px;text-align:center;
  pointer-events:none;             /* 蒙层不吃点，侧栏可点 */
}
.feedback button{pointer-events:auto;}  /* 只有按钮能点 */
.feedback p{font-size:1.2rem;font-weight:700;margin-bottom:.8rem}

/* ─── 公式重排 & 拼图样式 ───────────────────────────── */
.reorder-list{list-style:none;padding:0;margin-top:1rem;border:1px dashed #ccc;min-height:48px}
.reorder-list li{padding:.4rem .6rem;border-bottom:1px solid #eee;cursor:move;background:#fafafa}
.reorder-list li:last-child{border-bottom:none}

.puzzle-grid{display:grid;grid-template-columns:repeat(3,80px);gap:2px;margin-top:1rem}
.tile{width:80px;height:80px;background:#fafafa;border:1px solid #ddd;display:flex;justify-content:center;align-items:center;font-weight:700;cursor:pointer}
.empty{background:transparent;border:none;cursor:auto}
.lock-container{text-align:center}
.lock-input{margin-top:1rem}
</style>
</head>
<body>

<!-- 顶栏 -->
<header class="topbar">
  <span>Escape-Room Editor</span>
  <span>Dr McHale</span>
  <a href="#">Manage</a><a href="#">Log out</a>
</header>

<div class="layout">
  <!-- 侧栏缩略图 -->
  <aside class="sidebar" id="thumbs">
    <div class="thumb active"  data-tpl="tmpl-text"       ><div class="thumb-preview"></div></div>
    <div class="thumb"         data-tpl="tmpl-video"      ><div class="thumb-preview"></div></div>
    <div class="thumb"         data-tpl="tmpl-mcq"        ><div class="thumb-preview"></div></div>
    <div class="thumb"         data-tpl="tmpl-blank"      ><div class="thumb-preview"></div></div>
    <div class="thumb"         data-tpl="tmpl-interactive"><div class="thumb-preview"></div></div>
    <div class="thumb"         data-tpl="tmpl-image"      ><div class="thumb-preview"></div></div>
    <div class="thumb"         data-tpl="tmpl-unlock"     ><div class="thumb-preview"></div></div>
    <div class="thumb"         data-tpl="tmpl-reorder"    ><div class="thumb-preview"></div></div>
    <div class="thumb"         data-tpl="tmpl-slidepuzzle"><div class="thumb-preview"></div></div>
  </aside>

  <!-- 白板 + 控件 -->
  <div class="whiteboard-wrapper">
    <div id="wb" class="whiteboard" contenteditable="true">Double-click and start typing your story …</div>
    <div class="controls">
      <button id="saveBtn">Save Progress</button>
      <button id="prevBtn">Previous</button>
      <button id="submitBtn">Submit</button>
    </div>
  </div>

  <!-- 工具条（右） -->
  <aside class="toolbar">
    <h2>Slide settings</h2>

    <!-- 新增内容类型选择 -->
    <label>Content type
      <select id="typeSelect">
        <option value="tmpl-text">Text</option>
        <option value="tmpl-video">Video</option>
        <option value="tmpl-mcq">MCQ</option>
        <option value="tmpl-blank">Blank-Fill</option>
        <option value="tmpl-image">Image</option>
        <option value="tmpl-unlock">Unlock Game</option>
        <option value="tmpl-reorder">Formula Reorder</option>
        <option value="tmpl-slidepuzzle">Slide Puzzle</option>
      </select>
    </label>

    <label>Background <input type="color" id="bgPicker" value="#ffffff"></label>
    <label>Text colour <input type="color" id="fgPicker" value="#000000"></label>
    <label>Font size (px) <input type="number" id="fsPicker" value="16" min="10" max="72"></label>
  </aside>
</div>

<!-- ─── 模板区 ────────────────────────────────────────── -->
<template id="tmpl-text">
  Double-click and start typing your story …
</template>

<template id="tmpl-video">
  <p>Paste a YouTube/Vimeo embed link:</p>
  <textarea placeholder="https://www.youtube.com/embed/…"></textarea>
</template>

<template id="tmpl-mcq">
  <p>Select the correct answer:</p>
  <label><input type="radio" name="mcq" value="0"> Sydney</label><br>
  <label><input type="radio" name="mcq" value="0"> Melbourne</label><br>
  <label><input type="radio" name="mcq" value="1"> Canberra</label><br>
  <label><input type="radio" name="mcq" value="0"> Perth</label>
</template>

<template id="tmpl-blank">
  <p>Fill the blank and press Enter:</p>
  <input type="text" id="blankInput" placeholder="H₂O?">
</template>

<template id="tmpl-interactive">
  <p><strong>Conditional question (example)</strong></p>
  <p>If your UID ends in <em>odd</em>, answer 3 × 7.<br>
     If it ends in <em>even</em>, answer 8 + 5.</p>
  <input type="text" id="condInput" placeholder="Answer here">
</template>

<template id="tmpl-image">
  <p>Insert an image:</p>
  <input type="file" id="imgFile"><br>
  <img id="imgPreview" style="max-width:100%;margin-top:1rem;">
</template>

<template id="tmpl-unlock">
  <div class="lock-container">
    <button id="revealBtn">drag the window</button>
    <div id="shutter" class="hidden" style="margin-top:1rem;">clue <strong>3157</strong></div>
    <input type="text" id="codeInput" class="lock-input hidden" placeholder="passcode">
  </div>
</template>

<template id="tmpl-reorder">
  <p>Drag items to form the complete formula:</p>
  <ul id="reorderList" class="reorder-list"></ul>
</template>

<template id="tmpl-slidepuzzle">
  <p>Slide tiles to restore the formula:</p>
  <div id="puzzleGrid" class="puzzle-grid"></div>
</template>

<!-- ─── 反馈弹层 ─────────────────────────────────────── -->
<div id="feedback" class="feedback hidden">
  <p id="fbMsg">Correct!</p>
  <button id="fbOk">OK</button>
</div>

<!-- ─── 脚本 ─────────────────────────────────────────── -->
<script>
/* ======= 基础状态 ======= */
const templates = [
  'tmpl-text','tmpl-video','tmpl-mcq','tmpl-blank',
  'tmpl-interactive','tmpl-image','tmpl-unlock',
  'tmpl-reorder','tmpl-slidepuzzle'
];
let cur = 0;                 // 当前索引
let lastCorrect = false;     // 当前题目是否答对
const wb = document.getElementById('wb');

/* ======= 工具函数 ======= */
const shuffle = arr => arr.sort(()=>Math.random()-0.5);

/* 工具：隐藏反馈层 */
function hideFeedback(){ feedback.classList.add('hidden'); }

/* ======= 颜色/字体立即响应 ======= */
bgPicker.oninput=e=>wb.style.setProperty('--wb-bg',e.target.value);
fgPicker.oninput=e=>wb.style.setProperty('--wb-color',e.target.value);
fsPicker.oninput=e=>wb.style.fontSize=e.target.value+'px';

/* ======= 生成缩略图预览 ======= */
document.querySelectorAll('.thumb[data-tpl]').forEach(th=>{
  const tpl=document.getElementById(th.dataset.tpl);
  th.querySelector('.thumb-preview').innerHTML=tpl.innerHTML;
});

/* ======= 缩略图点击：切页面 + 关弹窗 ======= */
document.querySelectorAll('#thumbs .thumb').forEach((th,i)=>{
  th.onclick = () => {
    hideFeedback();
    if(i===cur) return;
    loadSlide(i);
  };
});

/* ======= 加载幻灯片 ======= */
function loadSlide(idx){
  cur = idx;
  document.querySelectorAll('#thumbs .thumb').forEach((t,i)=>t.classList.toggle('active',i===idx));
  const id = templates[idx];
  wb.innerHTML = document.getElementById(id).innerHTML;
  lastCorrect = false;
  initSlide(id);
  typeSel.value = id;     // 同步下拉框
  saveProgress();
}
function nextSlide(){ if(cur<templates.length-1) loadSlide(cur+1);}
function prevSlide(){ if(cur>0) loadSlide(cur-1);}

/* ======= 初始化各类型逻辑 ======= */
function initSlide(type){
  if(type==='tmpl-text'||type==='tmpl-video') lastCorrect=true;

  if(type==='tmpl-mcq'){
    wb.querySelectorAll('input[name="mcq"]').forEach(r=>{
      r.onchange=()=>lastCorrect=r.value==='1';
    });
  }
  if(type==='tmpl-blank'){
    const inp=wb.querySelector('#blankInput');
    inp.onkeydown=e=>{
      if(e.key==='Enter') lastCorrect=/h2o/i.test(inp.value.trim());
    };
  }
  if(type==='tmpl-interactive'){
    const inp=wb.querySelector('#condInput');
    inp.onkeydown=e=>{
      if(e.key==='Enter'){
        const v=inp.value.trim();
        lastCorrect = v==='21' || v==='13';
      }
    };
  }
  if(type==='tmpl-image'){
    const file=wb.querySelector('#imgFile');
    const prev=wb.querySelector('#imgPreview');
    file.onchange=e=>{
      const f=e.target.files[0];
      if(f) prev.src=URL.createObjectURL(f);
      lastCorrect=true;
    };
  }
  if(type==='tmpl-unlock'){
    const reveal=wb.querySelector('#revealBtn');
    const shutter=wb.querySelector('#shutter');
    const input=wb.querySelector('#codeInput');
    reveal.onclick=()=>{shutter.classList.remove('hidden');input.classList.remove('hidden');}
    input.onkeydown=e=>{
      if(e.key==='Enter') lastCorrect = input.value==='3157';
    };
  }
  if(type==='tmpl-reorder'){
    const terms=['Σ(X – μ)²','σ²','/','N','='];
    const correct=['σ²','=','Σ(X – μ)²','/','N'];
    const list=wb.querySelector('#reorderList');
    list.innerHTML='';
    shuffle(terms).forEach(t=>{
      const li=document.createElement('li');li.textContent=t;li.draggable=true;
      li.ondragstart=ev=>ev.dataTransfer.setData('text',t);
      list.appendChild(li);
    });
    list.ondragover=ev=>ev.preventDefault();
    list.ondrop=ev=>{
      const drag=ev.dataTransfer.getData('text');
      const target=ev.target.closest('li');
      if(!target)return;
      const items=[...list.children].map(li=>li.textContent);
      const i1=items.indexOf(drag), i2=items.indexOf(target.textContent);
      [items[i1],items[i2]]=[items[i2],items[i1]];
      list.innerHTML='';
      items.forEach(t=>{
        const li=document.createElement('li');li.textContent=t;li.draggable=true;
        li.ondragstart=e2=>e2.dataTransfer.setData('text',t);
        list.appendChild(li);
      });
      lastCorrect = items.join('|')===correct.join('|');
    };
  }
  if(type==='tmpl-slidepuzzle'){
    const parts=['σ²','=','Σ','(X','–','μ)','²/','N',''];
    const correct=[...parts];
    const grid=wb.querySelector('#puzzleGrid');
    grid.innerHTML='';
    shuffle(parts).forEach(txt=>{
      const div=document.createElement('div');
      div.className=txt===''?'tile empty':'tile';
      div.textContent=txt;
      div.onclick=()=>moveTile(div,grid);
      grid.appendChild(div);
    });
    function moveTile(div,grid){
      const empty=grid.querySelector('.empty');
      const idx1=[...grid.children].indexOf(div);
      const idx0=[...grid.children].indexOf(empty);
      if([1,-1,3,-3].includes(idx1-idx0)){
        grid.insertBefore(div, empty);
        grid.insertBefore(empty,grid.children[idx1]);
      }
      lastCorrect=[...grid.children].every((c,i)=>c.textContent===correct[i]);
    }
  }
}

/* ======= 提交 / 弹层 ======= */
function showFeedback(ok){
  const fb=document.getElementById('feedback');
  fbMsg.textContent = ok?'✔ Correct!':'✖ Wrong, try again';
  fb.style.background = ok?'var(--unsw-yellow)':'#ff5656';
  fb.classList.remove('hidden');
}
fbOk.onclick = () => {
  const ok = fbMsg.textContent.startsWith('✔');
  hideFeedback();
  if(ok) nextSlide();
};

/* ======= 保存进度 ======= */
function saveProgress(){ localStorage.setItem('escapeSlide',cur);}
function loadProgress(){
  const idx=+localStorage.getItem('escapeSlide');
  if(!isNaN(idx)&&idx>=0&&idx<templates.length) loadSlide(idx);
  else loadSlide(0);
}

/* ======= 事件绑定 ======= */
submitBtn.onclick=()=>showFeedback(lastCorrect);
prevBtn.onclick=prevSlide;
saveBtn.onclick=()=>{saveProgress();alert('Progress saved');}

/* 下拉框：即时切换模板 */
const typeSel=document.getElementById('typeSelect');
typeSel.onchange=e=>{
  const tplId=e.target.value;
  hideFeedback();
  wb.innerHTML=document.getElementById(tplId).innerHTML;
  lastCorrect=false;
  initSlide(tplId);
};

/* ======= 启动 ======= */
loadProgress();
</script>
</body>
</html>
